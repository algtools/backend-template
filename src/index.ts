import { ApiException, fromHono } from "chanfana";
import { Hono } from "hono";
import { tasksRouter } from "./endpoints/tasks/router";
import { ContentfulStatusCode } from "hono/utils/http-status";
import { DummyEndpoint } from "./endpoints/dummyEndpoint";

// Start a Hono app
const app = new Hono<{ Bindings: Env }>();

app.onError((err, c) => {
	if (err instanceof ApiException) {
		// If it's a Chanfana ApiException, let Chanfana handle the response
		return c.json(
			{ success: false, errors: err.buildResponse() },
			err.status as ContentfulStatusCode,
		);
	}

	console.error("Global error handler caught:", err); // Log the error if it's not known

	// For other errors, return a generic 500 response
	return c.json(
		{
			success: false,
			errors: [{ code: 7000, message: "Internal Server Error" }],
		},
		500,
	);
});

// Setup OpenAPI registry
const openapi = fromHono(app, {
	// Keep the autogenerated docs available, but serve Scalar at `/`
	docs_url: "/docs",
	schema: {
		info: {
			title: "My Awesome API",
			version: "2.0.0",
			description: "This is the documentation for my awesome API.",
		},
	},
});

app.get("/", (c) => {
	// Serve Scalar API Reference (static HTML) pointing to the generated OpenAPI schema
	// Note: `fromHono` serves the schema at `/openapi.json` in this template.
	const html = `<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>API Reference</title>
    <style>
      html, body { height: 100%; margin: 0; }
      #api-reference { height: 100%; }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@scalar/api-reference@latest/dist/style.css" />
  </head>
  <body>
    <div id="api-reference"></div>
    <script src="https://cdn.jsdelivr.net/npm/@scalar/api-reference@latest/dist/browser/standalone.js"></script>
    <script>
      (function () {
        var el = document.getElementById('api-reference');
        var config = { spec: { url: '/openapi.json' } };

        // Support multiple global APIs across Scalar versions/bundles.
        if (window.ScalarAPIReference && typeof window.ScalarAPIReference.render === 'function') {
          window.ScalarAPIReference.render(el, config);
          return;
        }
        if (window.Scalar && typeof window.Scalar.createApiReference === 'function') {
          window.Scalar.createApiReference(el, config);
          return;
        }
        // Fallback: some builds auto-mount from an element with data-url
        el.setAttribute('data-url', '/openapi.json');
      })();
    </script>
  </body>
</html>`;

	return c.html(html);
});

// Register Tasks Sub router
openapi.route("/tasks", tasksRouter);

// Register other endpoints
openapi.post("/dummy/:slug", DummyEndpoint);

// Export the Hono app
export default app;
